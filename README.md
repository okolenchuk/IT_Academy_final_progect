# Generating avatars with Stable Diffusoin model and your photos.

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/drive/1EFwdQckJrQ7se45cyn6Caf8bUWZDA59t#scrollTo=xhxFTElOXBU7)

You can try this model with your photos in google colaboratory with the link above.

### About project
- [Installation](#Installation)
- [Training](#Training)
- [Inference](#Inference)
- [Examples](#Examples)


### Installation

Python 3.6 +
```Shell
pip install -r requirements.txt
```
Used libraries:
- Matplotlib
- Pytorch
- Random_word
- Requests
- Regex
- Retinaface-pytorch
- Opencv-python
- Pillow
- Torchvision
- Bitsandbytes
- Accelerate
- Tqdm
- Transformers
- Diffusers


### Training

Example of console script for run.py that run photo preprocess and training.
All added photos will be processed by retinanet and only images of faces with a size of 512 * 512 will be submitted to the model for training

```Shell
python run.py \
--output_dir=$OUTPUT_DIR \
--instance_data_dir=$INSTANCE_DIR \
--class_data_dir=$INPUT_DIR \
--instance_prompt=$INSTANCE_NAME \
--num_class_images=50 \
--class_prompt=$CLASS_NAME \
--pretrained_model_name_or_path=$SD_VERSION \
--use_8bit_adam \
--learning_rate=1e-6 \
--max_train_steps=$NUM_TRAIN_STEPS \
--num_train_epochs=1 \
--save_sample_prompt=$INSTANCE_NAME \
--n_save_sample=$NUM_SAVE_SAMPLES \
--train_text_encoder 
```

- pretrained_model_name_or_path - Path to pretrained model or model identifier from huggingface.co/models
- instance_data_dir - A folder containing the training data of instance images
- class_data_dir - A folder containing the training data of class images. Will be generated by pretrained model
- instance_prompt - The prompt with identifier specifying the instance
- class_prompt - The prompt to specify images in the same class as provided instance images
- save_sample_prompt - The prompt used to generate sample outputs to save
- save_sample_negative_prompt - The negative prompt used to generate sample outputs to save
- n_save_sample - The number of samples to save
- save_guidance_scale - CFG for save sample
- save_infer_steps - The number of inference steps for save sample
- use_8bit_adam - Whether or not to use 8-bit Adam from bitsandbytes
- prior_loss_weight - The weight of prior preservation loss
- num_class_images - Minimal class images for prior preservation loss. If not have enough images, additional images will be sampled with class_prompt
- output_dir - The output directory where the model predictions and checkpoints will be written
- train_text_encoder - Whether to train the text encoder
- train_batch_size - Batch size (per device) for the training dataloader
- sample_batch_size - Batch size (per device) for sampling images
- num_train_epochs - Total number of training steps to perform.  If provided, overrides num_train_epochs
- learning_rate - Initial learning rate (after the potential warmup period) to use
- not_cache_latents - Do not precompute and cache latents from VAE
- local_rank - For distributed training: local_rank

While training some important variables will be saved in variables.json

{ \
  "pic_size": "(512, 512)", \
  "train_photo_path": "", \
  "trained_model_dir": "", \
  "output_path": "", \
  "instance_name": "", \
  "model_name": "", \
  "logs": "" \
}


### Inference

Example of console script for creation.py that run generating pictures with specific instance.

```Shell
python creation.py \
--instance_name=$instance \
--gender=$gender \
--n_images=$number_of_images \
--save_infer_steps=$n_infer_steps \
--save_path=$save_path \
--word=$word \
--use_saved_prompts=$use_saved_prompts
```

- instance_name - he prompt with identifier specifying the instance that was used on training
- gender - Gender with what you want to generate images.  Is used to choose presaved prompts
- n_images - he number of samples to 1 prompt
- save_infer_steps - The number of inference steps for generating images. 100 are recommended
- save_path - The output directory where the images will be saved
- word - Word to create context for random generating
- use_saved_prompts - Whether or not to use presaved prompts in /prompts/

### Examples

![MyCollages (2)](https://user-images.githubusercontent.com/58327451/209877493-9a103942-4980-44a0-bf5c-4a87803496e8.png)
![MyCollages (1)](https://user-images.githubusercontent.com/58327451/209878184-d51500fa-77e5-4dcd-867b-9b1e289c24f4.png)


